{"componentChunkName":"component---src-templates-post-js","path":"/posts/2021-04-03-building an api gateway with nginx and lua/","result":{"data":{"mdx":{"fields":{"slug":"/posts/2021-04-03-building an api gateway with nginx and lua/","date":"2003-04-20T05:00:00.000Z"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"template\": \"post\",\n  \"title\": \"Building an API Gateway with Nginx and Lua\",\n  \"slug\": \"building-an-api-gateway-with-nginx-and-lua\",\n  \"cover\": \"food_01.webp\",\n  \"draft\": true,\n  \"date\": \"2021-04-03T13:11:52.449Z\",\n  \"excerpt\": \"Nginx is a web server that can also be used as a reverse proxy\",\n  \"category\": \"backend\",\n  \"tags\": [\"nginx\", \"lua\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h3\", {\n    \"id\": \"building-an-api-gateway-with-nginx--lua\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#building-an-api-gateway-with-nginx--lua\",\n    \"aria-label\": \"building an api gateway with nginx  lua permalink\",\n    \"className\": \"anchor-heading before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Building an API Gateway with Nginx + Lua\"), mdx(\"p\", null, \"Nginx is a web server that can also be used as a reverse proxy, load balancer, mail proxy, and HTTP cache. Nginx could be used to create an API Gateway that processes requests in an event-driven manner, handling queries to the server in a quick, low-resource-footprint manner as they come in. Further, it reduces complexity and maximizes the performance by reducing the average response time to serve an API call.  \"), mdx(\"p\", null, \"Most of us are already familiar with Kong but, I wanted to explore the possibility of using OpenResty to build an API Gateway.\"), mdx(\"h3\", {\n    \"id\": \"implementation\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#implementation\",\n    \"aria-label\": \"implementation permalink\",\n    \"className\": \"anchor-heading before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Implementation\"), mdx(\"p\", null, \"The first thing we need to do is to install OpenResty. OpenResty gives us the capability of scripting Nginx using Lua.  \"), mdx(\"p\", null, \"Once installed, you should navigate to your browser and type \", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"http://localhost.\"\n  }, \"http://localhost.\"), \" If everything goes well, you will see the below screenshot:\"), mdx(\"p\", null, \"With this, you have successfully installed OpenResty along with Nginx.  \"), mdx(\"p\", null, \"Now, we need to edit the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"em\", {\n    parentName: \"strong\"\n  }, \"nginx.conf\")), \" file. You can find the nginx.conf file in the below locations:  \"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"em\", {\n    parentName: \"li\"\n  }, \"Ubuntu : /usr/local/openresty/nginx/conf\")), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"em\", {\n    parentName: \"li\"\n  }, \"Mac: /usr/local/Cellar/openresty/nginx/conf (using homebrew)\"))), mdx(\"p\", null, \"Note: You can also add the configuration in a new file and include it in \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"em\", {\n    parentName: \"strong\"\n  }, \"nginx.conf\")), \".\"), mdx(\"p\", null, \"For a basic API gateway, there are two important operations that it should perform:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"Routing\")), mdx(\"li\", {\n    parentName: \"ol\"\n  }, mdx(\"strong\", {\n    parentName: \"li\"\n  }, \"Authentication\"))), mdx(\"h3\", {\n    \"id\": \"routing\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#routing\",\n    \"aria-label\": \"routing permalink\",\n    \"className\": \"anchor-heading before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Routing\"), mdx(\"p\", null, \"To route the endpoints to their respective servers, all you need to do is:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-nginx\"\n  }, \"location /api/test {\\n    proxy_pass http://localhost:8080/api/test;\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"authentication\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#authentication\",\n    \"aria-label\": \"authentication permalink\",\n    \"className\": \"anchor-heading before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Authentication\"), mdx(\"p\", null, \"To perform authentication, I will be using JWT. To do that, we need to install the \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"lua-resty-jwt\"), \" library using \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"OPM(OpenResty Package Manager)\"), \".\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-shellsession\"\n  }, \"opm get SkyLothar/lua-resty-jwt\\n\")), mdx(\"p\", null, \"Next, create a \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"em\", {\n    parentName: \"strong\"\n  }, \"jwt-auth.lua\")), \" in \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"/usr/local/openresty/lualib/resty\"), \" (Ubuntu) and copy the below code:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-lua\"\n  }, \"local jwt = require 'resty.jwt'\\nlocal validators = require 'resty.jwt-validators'\\n\\nif ngx.var.request_method ~= 'OPTIONS' and not string.match(ngx.var.uri, 'login') then\\n\\n  local jwtToken = ngx.var.http_Authorization\\n\\n  if jwtToken == nil then\\n    ngx.status = ngx.HTTP_UNAUTHORIZED\\n    ngx.header.content_type = 'application/json; charset=utf-8'\\n    ngx.say('{\\\\'error\\\\': \\\\'Forbidden\\\\'}')\\n    ngx.exit(ngx.HTTP_UNAUTHORIZED)\\n  end\\n\\n  local claim_spec = {\\n    exp = validators.is_not_expired()\\n  }\\n  \\n  local jwt_obj = jwt:verify(\\u2018secret\\u2019, jwtToken, claim_spec)\\n  \\n  if not jwt_obj['verified'] then\\n    ngx.status = ngx.HTTP_UNAUTHORIZED\\n    ngx.header.content_type = 'application/json; charset=utf-8'\\n    ngx.say('{\\\\'error\\\\': \\\\'INVALID_JWT\\\\'}')\\n    ngx.exit(ngx.HTTP_UNAUTHORIZED)\\n  end\\n\\nend\\n\")), mdx(\"p\", null, \"The above Lua code does the following:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"It forwards the request to the next line of execution if it is an OPTIONS call or a login API.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Otherwise, it fetches the JWT token in the Authorization header. If the token is not present, the code returns \\u2018FORBIDDEN\\u2019.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"This JWT token is then validated for authenticity and expiry date.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Once the token is validated, it forwards the request to the respective service. Else, it returns \\u2018INVALID_JWT\\u2019.\")), mdx(\"p\", null, \"Include the above file in your \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"em\", {\n    parentName: \"strong\"\n  }, \"nginx.conf\")), \".\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-nginx\"\n  }, \"location /api/test {\\n    access_by_lua_file /usr/local/openresty/lualib/resty/jwt_auth.lua;\\n    proxy_pass http://localhost:8080/api/test;\\n}\\n\")), mdx(\"p\", null, \"That\\u2019s it. You have added JWT authentication on Nginx.\"), mdx(\"h3\", {\n    \"id\": \"testing\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#testing\",\n    \"aria-label\": \"testing permalink\",\n    \"className\": \"anchor-heading before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Testing\"), mdx(\"p\", null, \"To check the changes we have made, restart \", mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"OpenResty\"), \" using the below command\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"sudo service openresty restart\\n\")), mdx(\"p\", null, \"Once you restart, hit the API using Postman or any other REST client and validate the response.\"), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, mdx(\"em\", {\n    parentName: \"strong\"\n  }, \"Tip:\")), \" \", mdx(\"em\", {\n    parentName: \"p\"\n  }, \"You can generate JWT tokens using this website: \", mdx(\"a\", {\n    parentName: \"em\",\n    \"href\": \"http://jwtbuilder.jamiekurtz.com/\"\n  }, \"http://jwtbuilder.jamiekurtz.com/\"))), mdx(\"h3\", {\n    \"id\": \"todo\",\n    \"style\": {\n      \"position\": \"relative\"\n    }\n  }, mdx(\"a\", {\n    parentName: \"h3\",\n    \"href\": \"#todo\",\n    \"aria-label\": \"todo permalink\",\n    \"className\": \"anchor-heading before\"\n  }, mdx(\"svg\", {\n    parentName: \"a\",\n    \"aria-hidden\": \"true\",\n    \"focusable\": \"false\",\n    \"height\": \"16\",\n    \"version\": \"1.1\",\n    \"viewBox\": \"0 0 16 16\",\n    \"width\": \"16\"\n  }, mdx(\"path\", {\n    parentName: \"svg\",\n    \"fillRule\": \"evenodd\",\n    \"d\": \"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"\n  }))), \"Todo\"), mdx(\"p\", null, \"We can improve our auth script by doing the following:\"), mdx(\"ol\", null, mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"A mechanism to add new API endpoints that don\\u2019t need a JWT token like downloads API.\"), mdx(\"li\", {\n    parentName: \"ol\"\n  }, \"Currently, JWT secret token is hardcoded in the script. Maybe we could set it as an environment variable to make it dynamic.\")));\n}\n;\nMDXContent.isMDXComponent = true;","excerpt":"Nginx is a web server that can also be used as a reverse proxy","frontmatter":{"title":"Building an API Gateway with Nginx and Lua","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8e8e8","images":{"fallback":{"src":"/static/9edbe792d0084cfb066f3f1eee035745/f6887/food_01.webp","srcSet":"/static/9edbe792d0084cfb066f3f1eee035745/53656/food_01.webp 1000w,\n/static/9edbe792d0084cfb066f3f1eee035745/a42a0/food_01.webp 2000w,\n/static/9edbe792d0084cfb066f3f1eee035745/f6887/food_01.webp 4000w","sizes":"(min-width: 4000px) 4000px, 100vw"},"sources":[]},"width":4000,"height":3077.0000000000005}}},"date":"04/03/2021","category":"backend","tags":["nginx","lua"],"excerpt":"Nginx is a web server that can also be used as a reverse proxy","draft":true}}},"pageContext":{"slug":"/posts/2021-04-03-building an api gateway with nginx and lua/","prev":{"fields":{"slug":"/posts/2021-01-04-sample-post-9/index.js/"},"frontmatter":{"title":"Post 9","cover":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#e8e8e8","images":{"fallback":{"src":"/static/5f4e5c682544183cb1571ef0cbbd4c7a/16298/photo-9.webp","srcSet":"/static/5f4e5c682544183cb1571ef0cbbd4c7a/b0107/photo-9.webp 1239w,\n/static/5f4e5c682544183cb1571ef0cbbd4c7a/b442a/photo-9.webp 2478w,\n/static/5f4e5c682544183cb1571ef0cbbd4c7a/16298/photo-9.webp 4956w","sizes":"(min-width: 4956px) 4956px, 100vw"},"sources":[]},"width":4956,"height":3304}}},"date":"2021-01-04T00:00:00.000Z","tags":["How to","Mdx"],"category":"post","draft":false,"excerpt":"Mdx Example 9"}}}},"staticQueryHashes":["3649515864","3657948673","63159454"]}